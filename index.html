<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scout Adventures Volunteers</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #fff5f5;
      color: #8b0000; /* dark red */
    }
    .container {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(139,0,0,0.2);
      border: 1px solid #8b0000;
    }
    h1, h2 {
      margin-top: 0;
      color: #b22222; /* fire red */
    }
    button {
      background-color: #b22222;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
      user-select: none;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #8b0000;
    }
    .btn-secondary {
      background-color: #f08080;
      color: #8b0000;
    }
    .btn-secondary:hover {
      background-color: #cd5c5c;
      color: white;
    }
    input[type="text"], textarea, select, input[type="date"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px 0;
      border-radius: 5px;
      border: 1px solid #b22222;
      box-sizing: border-box;
      font-family: sans-serif;
      font-size: 14px;
      color: #8b0000;
      background: #fff0f0;
    }
    input[type="file"] {
      margin: 6px 0 20px 0;
      display: block;
      color: #8b0000;
    }
    #searchForm {
      margin-bottom: 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    #searchForm input, #searchForm button, #searchForm select {
      flex: 1 1 auto;
      min-width: 120px;
      color: #8b0000;
      background: #fff0f0;
      border: 1px solid #b22222;
    }
    .post {
      border: 1px solid #b22222;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      background: #ffe5e5;
    }
    .post img, .post video {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 4px;
    }
    .message {
      font-weight: bold;
      margin-top: 10px;
      color: #b22222;
    }
  </style>
</head>
<body>
  <div class="container" id="root">
    <!-- Content loads here -->
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      Timestamp,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
       apiKey: "AIzaSyDd5imbrEvLcByokkT__Xyz3PBHLEEChQ8",
       authDomain: "sa-youlboury-volunteers.firebaseapp.com",
       projectId: "sa-youlboury-volunteers",
       storageBucket: "sa-youlboury-volunteers.firebasestorage.app",
       messagingSenderId: "400363651786",
       appId: "1:400363651786:web:70e3f9830555e03272ea33"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const root = document.getElementById("root");

    let currentUser = null;
    let currentYear = null;
    let currentMonth = null;

    function renderLogin() {
      root.innerHTML = `
        <h2>Log in</h2>
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button id="loginBtn">Sign in</button>
      `;
      document.getElementById("loginBtn").onclick = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (e) {
          alert("Login error: " + e.message);
        }
      };
    }

    function renderInicio() {
      currentYear = null;
      currentMonth = null;
      root.innerHTML = `
        <header>
          <h1>Scout Adventures Volunteers</h1>
          <div>
            Welcome, ${currentUser.email}
            <button id="logoutBtn">Log out</button>
          </div>
        </header>

        <section>
          <h2>Search posts by date</h2>
          <form id="searchForm">
            <input type="number" id="searchYear" placeholder="Year (e.g. 2023)" min="2000" max="2100" />
            <select id="searchMonth">
              <option value="">Month (optional)</option>
              ${Array.from({length: 12}, (_, i) => `<option value="${i+1}">${monthName(i+1)}</option>`).join("")}
            </select>
            <input type="number" id="searchDay" placeholder="Day (optional)" min="1" max="31" />
            <button type="submit">Search</button>
          </form>
          <div id="searchResults"></div>
        </section>

        <section>
          <h2>Years</h2>
          <div id="yearsContainer"></div>
          <button id="addYearBtn" class="btn-secondary">Add Year</button>
        </section>

        <div id="message" class="message"></div>
      `;

      document.getElementById("logoutBtn").onclick = async () => {
        await signOut(auth);
      };

      document.getElementById("addYearBtn").onclick = () => {
        const y = prompt("Enter the new year (e.g. 2026):");
        if (!y || isNaN(y) || y < 2000 || y > 2100) {
          alert("Invalid year");
          return;
        }
        renderMeses(parseInt(y));
      };

      document.getElementById("searchForm").onsubmit = async (e) => {
        e.preventDefault();
        await buscarPorFecha();
      };

      cargarAnios();
    }

    async function cargarAnios() {
      const yearsContainer = document.getElementById("yearsContainer");
      yearsContainer.innerHTML = "";
      const years = [2023, 2024, 2025];
      years.forEach(y => {
        const btn = document.createElement("button");
        btn.textContent = y;
        btn.onclick = () => renderMeses(y);
        yearsContainer.appendChild(btn);
      });
    }

    function renderMeses(year) {
      currentYear = year;
      currentMonth = null;

      root.innerHTML = `
        <header>
          <h1>Year ${year}</h1>
          <button id="backBtn" class="btn-secondary">← Back to Home</button>
        </header>
        <section>
          <h2>Months</h2>
          <div id="monthsContainer"></div>
        </section>
      `;

      document.getElementById("backBtn").onclick = () => renderInicio();

      const monthsContainer = document.getElementById("monthsContainer");
      for (let m=1; m<=12; m++) {
        const btn = document.createElement("button");
        btn.textContent = monthName(m);
        btn.onclick = () => renderPostsMes(year, m);
        monthsContainer.appendChild(btn);
      }
    }

    // Reemplazada para usar onSnapshot y actualizar en tiempo real
    function renderPostsMes(year, month) {
      currentYear = year;
      currentMonth = month;

      root.innerHTML = `
        <header>
          <h1>Posts from ${monthName(month)} ${year}</h1>
          <button id="backBtn" class="btn-secondary">← Back to Year</button>
        </header>
        <section>
          <button id="addPostBtn">Add post</button>
        </section>
        <section id="postsContainer">
          <p>Loading posts...</p>
        </section>
      `;

      document.getElementById("backBtn").onclick = () => renderMeses(year);
      document.getElementById("addPostBtn").onclick = () => renderFormPost(year, month);

      const postsContainer = document.getElementById("postsContainer");

      const start = new Date(year, month-1, 1);
      const end = new Date(year, month, 1);
      const postsRef = collection(db, "posts");
      const q = query(postsRef,
        where("date", ">=", Timestamp.fromDate(start)),
        where("date", "<", Timestamp.fromDate(end)),
        orderBy("date", "asc")
      );

      // Escucha en tiempo real
      onSnapshot(q, (snapshot) => {
        postsContainer.innerHTML = "";
        if (snapshot.empty) {
          postsContainer.textContent = "No posts for this month.";
          return;
        }
        snapshot.forEach(doc => {
          const p = doc.data();
          const date = p.date.toDate();
          postsContainer.innerHTML += `
            <div class="post">
              <strong>${date.getDate()} ${monthName(month)}</strong><br/>
              <p>${escapeHtml(p.text)}</p>
              ${p.imageUrl ? `<img src="${p.imageUrl}" alt="image"/>` : ""}
              ${p.videoUrl ? `<video src="${p.videoUrl}" controls></video>` : ""}
              <small>Posted by: ${escapeHtml(p.author)}</small>
            </div>
          `;
        });
      }, (error) => {
        postsContainer.textContent = "Error loading posts: " + error.message;
      });
    }

    function monthName(month) {
      return [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ][month-1];
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/[&<>"']/g, function(m) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[m];
      });
    }

    function renderFormPost(year, month) {
      root.innerHTML = `
        <header>
          <h1>Add Post for ${monthName(month)} ${year}</h1>
          <button id="backBtn" class="btn-secondary">← Back to Posts</button>
        </header>
        <form id="postForm">
          <label>Text</label>
          <textarea id="postText" required></textarea>

          <label>Image (optional)</label>
          <input type="file" id="postImage" accept="image/*" />

          <label>Video URL (optional)</label>
          <input type="text" id="postVideo" placeholder="https://example.com/video.mp4" />

          <button type="submit">Add Post</button>
        </form>
        <div id="formMessage"></div>
      `;

      document.getElementById("backBtn").onclick = () => renderPostsMes(year, month);

      document.getElementById("postForm").onsubmit = async (e) => {
        e.preventDefault();
        const text = document.getElementById("postText").value.trim();
        const imageFile = document.getElementById("postImage").files[0];
        const videoUrl = document.getElementById("postVideo").value.trim();

        if (!text) {
          alert("Text is required");
          return;
        }

        const formMessage = document.getElementById("formMessage");
        formMessage.textContent = "Uploading...";

        try {
          let imageUrl = "";
          if (imageFile) {
            const imageRef = ref(storage, `posts/${Date.now()}_${imageFile.name}`);
            await uploadBytes(imageRef, imageFile);
            imageUrl = await getDownloadURL(imageRef);
          }

          const date = new Date(year, month-1, 1);
          await addDoc(collection(db, "posts"), {
            text,
            imageUrl,
            videoUrl,
            author: currentUser.email,
            date: Timestamp.fromDate(date)
          });

          formMessage.textContent = "Post added successfully!";
          setTimeout(() => renderPostsMes(year, month), 1500);
        } catch (error) {
          formMessage.textContent = "Error: " + error.message;
        }
      };
    }

    async function buscarPorFecha() {
      const yearInput = document.getElementById("searchYear").value;
      const monthInput = document.getElementById("searchMonth").value;
      const dayInput = document.getElementById("searchDay").value;
      const searchResults = document.getElementById("searchResults");

      if (!yearInput) {
        alert("Please enter a year");
        return;
      }

      searchResults.innerHTML = "Searching...";

      try {
        let q = collection(db, "posts");
        const year = parseInt(yearInput);

        let start, end;
        if (monthInput) {
          const month = parseInt(monthInput);
          if (dayInput) {
            const day = parseInt(dayInput);
            start = new Date(year, month-1, day);
            end = new Date(year, month-1, day + 1);
          } else {
            start = new Date(year, month-1, 1);
            end = new Date(year, month, 1);
          }
        } else {
          start = new Date(year, 0, 1);
          end = new Date(year + 1, 0, 1);
        }

        const postsRef = collection(db, "posts");
        const postsQuery = query(postsRef,
          where("date", ">=", Timestamp.fromDate(start)),
          where("date", "<", Timestamp.fromDate(end)),
          orderBy("date", "asc")
        );

        const snapshot = await getDocs(postsQuery);

        if (snapshot.empty) {
          searchResults.textContent = "No posts found for that date.";
          return;
        }

        searchResults.innerHTML = "";
        snapshot.forEach(doc => {
          const p = doc.data();
          const date = p.date.toDate();
          searchResults.innerHTML += `
            <div class="post">
              <strong>${date.toDateString()}</strong><br/>
              <p>${escapeHtml(p.text)}</p>
              ${p.imageUrl ? `<img src="${p.imageUrl}" alt="image"/>` : ""}
              ${p.videoUrl ? `<video src="${p.videoUrl}" controls></video>` : ""}
              <small>Posted by: ${escapeHtml(p.author)}</small>
            </div>
          `;
        });
      } catch (error) {
        searchResults.textContent = "Error searching posts: " + error.message;
      }
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        renderInicio();
      } else {
        renderLogin();
      }
    });
  </script>
</body>
</html>
